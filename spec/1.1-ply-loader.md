# Spec 1.1: PLY Loader

**Module:** Ingestion
**Phase:** 1 - Foundation
**Week:** 1

## Overview

Parse binary PLY files containing 3D Gaussian Splatting data and extract per-Gaussian attributes into memory.

## Input

- Binary PLY file from gsplat/nerfstudio output
- Expected properties per vertex:
  - `x, y, z` - Position (float32)
  - `scale_0, scale_1, scale_2` - Scale parameters (float32)
  - `rot_0, rot_1, rot_2, rot_3` - Rotation quaternion (float32)
  - `opacity` - Alpha value (float32)
  - `f_dc_0, f_dc_1, f_dc_2` - DC spherical harmonic coefficients (float32)
  - `f_rest_*` - Higher-order SH coefficients (float32 x 45)

## Output

```cpp
struct RawGaussian {
    Eigen::Vector3f position;
    Eigen::Vector3f scale;
    Eigen::Quaternionf rotation;
    float opacity;
    std::array<float, 48> sh_coefficients;  // 3 DC + 45 higher-order
};

std::vector<RawGaussian> load_ply(const std::filesystem::path& path);
```

## Requirements

### Functional

- [ ] Parse PLY header to detect binary format (little/big endian)
- [ ] Extract vertex count from header
- [ ] Read all required properties per Gaussian
- [ ] Handle missing optional properties gracefully (higher-order SH)
- [ ] Validate quaternion normalization (warn if |q| deviates from 1.0)
- [ ] Report file statistics: vertex count, file size, load time

### Error Handling

- [ ] Throw on missing required properties (position, scale, rotation, opacity)
- [ ] Throw on file not found or permission denied
- [ ] Throw on corrupted/truncated file
- [ ] Warn on unexpected properties (log but continue)

### Performance

- [ ] Load 1M Gaussians in < 2 seconds
- [ ] Memory-map large files where possible
- [ ] Single-pass parsing (no seeking)

## Dependencies

- `tinyply` or `happly` for PLY parsing
- `Eigen` for vector/quaternion types

## Test Cases

| Test | Input | Expected |
|------|-------|----------|
| Basic load | Valid 3DGS PLY | All properties extracted |
| Missing SH | PLY without f_rest_* | Load succeeds, SH zeroed |
| Bad quaternion | \|q\| = 1.5 | Warning logged, quaternion normalized |
| Truncated file | Incomplete PLY | Exception thrown |
| ASCII PLY | Text format PLY | Exception (unsupported) |

## API

```cpp
namespace geode {

struct LoadResult {
    std::vector<RawGaussian> gaussians;
    size_t file_size_bytes;
    double load_time_ms;
};

// Load 3DGS PLY file
LoadResult load_ply(const std::filesystem::path& path);

// Check if file is valid 3DGS PLY (header inspection only)
bool is_valid_3dgs_ply(const std::filesystem::path& path);

}  // namespace geode
```

## Notes

- Only binary PLY is supported (ASCII is too slow for production assets)
- Quaternion convention: scalar-first (w, x, y, z) matching gsplat output
- SH coefficients stored in band order: DC (l=0), then l=1, l=2, l=3
