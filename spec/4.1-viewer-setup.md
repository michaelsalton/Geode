# Spec 4.1: Viewer Setup

**Module:** Visualization
**Phase:** 3 - Visualization
**Week:** 7

## Overview

Integrate Polyscope visualization library to display 3DGS scenes as interactive point clouds with SH-derived colors. This serves as the foundation for classification visualization and debugging tools.

## Dependencies

- **Polyscope** - C++ 3D visualization library with ImGui
- **OpenGL 3.3+** - Rendering backend

## Features

### Basic Scene Display

Display loaded scene as a colored point cloud:

```cpp
void display_scene(const Scene& scene) {
    // Extract positions
    std::vector<glm::vec3> positions;
    for (const auto& p : scene.primitives) {
        positions.push_back({p.position.x(), p.position.y(), p.position.z()});
    }

    // Extract colors from SH DC term
    std::vector<glm::vec3> colors;
    for (const auto& p : scene.primitives) {
        // SH DC to RGB (with SH normalization constant)
        float r = 0.5f + 0.28209479f * p.sh_coefficients[0];
        float g = 0.5f + 0.28209479f * p.sh_coefficients[1];
        float b = 0.5f + 0.28209479f * p.sh_coefficients[2];
        colors.push_back({
            std::clamp(r, 0.0f, 1.0f),
            std::clamp(g, 0.0f, 1.0f),
            std::clamp(b, 0.0f, 1.0f)
        });
    }

    auto* cloud = polyscope::registerPointCloud("scene", positions);
    cloud->addColorQuantity("color", colors)->setEnabled(true);
}
```

### Camera Controls

Polyscope provides built-in controls:
- **Left-click drag**: Rotate
- **Right-click drag**: Pan
- **Scroll**: Zoom
- **Double-click**: Focus on point

### Point Size Scaling

Adapt point size based on scene extent:

```cpp
float compute_point_size(const Scene& scene) {
    float extent = scene.extent.maxCoeff();
    // Heuristic: ~1000 points visible at default zoom
    return extent / 500.0f;
}
```

## Requirements

### Functional

- [ ] Initialize Polyscope with appropriate settings
- [ ] Display scene as point cloud
- [ ] Color points using SH DC coefficients
- [ ] Configurable point size
- [ ] Show scene statistics in UI panel

### Performance

- [ ] Handle 500K+ primitives at interactive frame rates (30+ FPS)
- [ ] Lazy loading for very large scenes
- [ ] GPU-accelerated rendering

### UI Elements

- [ ] Scene info panel (primitive count, bounds, extent)
- [ ] Point size slider
- [ ] Color mode selector (SH color, solid, none)
- [ ] Screenshot button

## Polyscope Configuration

```cpp
void init_viewer() {
    polyscope::options::programName = "GEODE Viewer";
    polyscope::options::groundPlaneMode = polyscope::GroundPlaneMode::ShadowOnly;
    polyscope::options::shadowBlurIters = 2;
    polyscope::options::autocenterStructures = true;
    polyscope::options::autoscaleStructures = true;

    polyscope::init();
}
```

## API

```cpp
namespace geode {

class Viewer {
public:
    Viewer();
    ~Viewer();

    // Load and display scene
    void load_scene(const Scene& scene);

    // Run interactive loop (blocking)
    void show();

    // Take screenshot
    void screenshot(const std::filesystem::path& path);

    // Access point cloud for additional quantities
    polyscope::PointCloud* get_point_cloud();

private:
    const Scene* scene_ = nullptr;
    polyscope::PointCloud* cloud_ = nullptr;
};

}  // namespace geode
```

## Test Cases

| Test | Input | Expected |
|------|-------|----------|
| Small scene | 1K primitives | Instant load, smooth interaction |
| Medium scene | 100K primitives | < 1s load, smooth interaction |
| Large scene | 1M primitives | < 5s load, acceptable interaction |
| Colors | Various SH values | Correct RGB mapping |
| Empty scene | 0 primitives | Graceful handling |

## Implementation Notes

### SH to RGB Conversion

The SH DC term needs proper conversion:

```cpp
// SH basis function for l=0, m=0
const float SH_C0 = 0.28209479177387814f;  // 1 / (2 * sqrt(pi))

vec3 sh_to_rgb(const float* sh_dc) {
    return vec3(
        0.5f + SH_C0 * sh_dc[0],
        0.5f + SH_C0 * sh_dc[1],
        0.5f + SH_C0 * sh_dc[2]
    );
}
```

### Large Scene Handling

For scenes > 500K primitives:
- Use LOD (show every Nth point when zoomed out)
- Frustum culling
- Progressive loading

## Notes

- Polyscope manages its own OpenGL context
- ImGui is included with Polyscope
- This spec covers basic viewing; classification visualization in Spec 4.2
- Viewer can run standalone or be integrated into classification pipeline
