# Spec 6.1: CLI Interface

**Module:** Polish & Documentation
**Phase:** 6 - Polish & Documentation
**Week:** 14

## Overview

Command-line interface for batch processing 3DGS assets through the GEODE pipeline, from PLY input to HGA output.

## Usage

```bash
# Basic usage
geode input.ply -o output.hga

# With options
geode input.ply -o output.hga --config thresholds.json --compress

# Classification only (no mesh conversion)
geode input.ply --classify-only -o manifest.json

# Viewer mode
geode input.ply --view

# Batch processing
geode *.ply -o output_dir/ --parallel 4
```

## Commands & Options

### Main Command

```
geode <input> [options]

Arguments:
  input                     Input 3DGS PLY file or directory

Options:
  -o, --output <path>       Output path (.hga file or directory)
  -c, --config <path>       Threshold configuration JSON
  -v, --verbose             Verbose output
  -q, --quiet               Suppress non-error output
  --version                 Print version and exit
  --help                    Print help and exit
```

### Processing Options

```
Processing:
  --classify-only           Output classification manifest only (no conversion)
  --no-mesh                 Skip mesh extraction (Gaussians only in output)
  --no-compress             Disable output compression
  --compress                Enable gzip compression
  --draco                   Use Draco mesh compression
```

### Threshold Overrides

```
Thresholds (override config file):
  --planarity <float>       Planarity threshold (default: 0.7)
  --erank-low <float>       Effective rank lower bound (default: 1.8)
  --erank-high <float>      Effective rank upper bound (default: 2.2)
  --alpha-mean <float>      Alpha mean threshold (default: 0.85)
  --alpha-var <float>       Alpha variance threshold (default: 0.1)
  --coherence <float>       Normal coherence threshold (default: 0.7)
```

### Clustering Options

```
Clustering:
  --cluster-size <int>      Target cluster size (default: 500)
  --grid-resolution <int>   Spatial hash resolution (default: 64)
```

### Mesh Extraction Options

```
Mesh Extraction:
  --poisson-depth <int>     Poisson octree depth (default: 8)
  --max-vertices <int>      Max vertices per cluster (default: 50000)
```

### Output Options

```
Output:
  --format <fmt>            Output format: hga, json, ply (default: hga)
  --export-clusters         Export per-cluster colored PLY
  --export-manifest         Export classification JSON alongside HGA
```

### Viewer Options

```
Viewer:
  --view                    Open interactive viewer after processing
  --view-only               View without processing (load existing results)
```

### Batch Processing

```
Batch:
  --parallel <n>            Process n files in parallel (default: 1)
  --continue-on-error       Don't stop batch on individual failures
```

## Output Format

### Standard Output

```
GEODE v1.0.0 - Heterogeneous Labeling Heuristic

Loading: scene.ply
  Primitives: 50,000
  Bounds: (-10.0, -5.0, 0.0) to (10.0, 5.0, 3.0)

Clustering...
  Clusters: 42
  Avg size: 1,190 primitives

Classifying...
  MESH_OPTIMAL:     18 clusters (22,000 primitives)
  GAUSSIAN_OPTIMAL: 21 clusters (26,500 primitives)
  UNCERTAIN:         3 clusters (1,500 primitives)

Extracting meshes...
  Vertices: 15,234
  Triangles: 28,102

Writing: scene.hga
  File size: 3.5 MB

Done in 2.3s
```

### Verbose Output (-v)

```
[DEBUG] PLY header: binary_little_endian
[DEBUG] Properties: x, y, z, scale_0, scale_1, scale_2, rot_0, ...
[DEBUG] Loading primitives... 50,000 in 0.8s
[DEBUG] Building spatial hash grid (64^3)...
[DEBUG] K-means: k=42, converged in 23 iterations
[DEBUG] Cluster 0: 1,234 primitives, centroid=(1.2, 0.5, 0.1)
...
```

### JSON Output (--format json)

```json
{
    "input": "scene.ply",
    "output": "scene.hga",
    "duration_ms": 2300,
    "primitives": 50000,
    "clusters": {
        "total": 42,
        "mesh_optimal": 18,
        "gaussian_optimal": 21,
        "uncertain": 3
    },
    "mesh": {
        "vertices": 15234,
        "triangles": 28102
    },
    "output_size_bytes": 3670016
}
```

## Exit Codes

| Code | Meaning |
|------|---------|
| 0 | Success |
| 1 | General error |
| 2 | Invalid arguments |
| 3 | File not found |
| 4 | Invalid input format |
| 5 | Processing error |
| 6 | Output write error |

## Requirements

### Functional

- [ ] Parse command-line arguments
- [ ] Load configuration from JSON
- [ ] Override config with CLI flags
- [ ] Support single file and batch processing
- [ ] Support multiple output formats
- [ ] Progress reporting for long operations
- [ ] Clean error messages

### Usability

- [ ] Sensible defaults (zero-config for basic use)
- [ ] Tab completion hints
- [ ] Man page / --help documentation
- [ ] Exit codes for scripting

### Performance

- [ ] Parallel batch processing
- [ ] Progress bar for large files
- [ ] Memory usage reporting (verbose mode)

## Implementation

### Argument Parsing

Use a library like CLI11 or argparse:

```cpp
#include <CLI/CLI.hpp>

int main(int argc, char** argv) {
    CLI::App app{"GEODE - Heterogeneous Labeling Heuristic"};

    std::string input;
    std::string output;
    std::string config;
    bool verbose = false;
    bool classify_only = false;

    app.add_argument("input", input, "Input PLY file")->required();
    app.add_option("-o,--output", output, "Output path");
    app.add_option("-c,--config", config, "Config JSON");
    app.add_flag("-v,--verbose", verbose, "Verbose output");
    app.add_flag("--classify-only", classify_only);

    CLI11_PARSE(app, argc, argv);

    // Run pipeline...
}
```

### Progress Reporting

```cpp
class ProgressReporter {
public:
    void start(const std::string& stage, size_t total);
    void update(size_t current);
    void finish();

private:
    bool is_tty_;  // Detect if output is terminal
    // Use \r for in-place updates on TTY
};
```

## API

```cpp
namespace geode {

struct CLIOptions {
    std::filesystem::path input;
    std::filesystem::path output;
    std::filesystem::path config;

    bool verbose = false;
    bool quiet = false;
    bool classify_only = false;
    bool no_mesh = false;
    bool compress = false;
    bool view = false;

    std::optional<float> planarity;
    std::optional<float> erank_low;
    // ... other threshold overrides

    int parallel = 1;
    bool continue_on_error = false;
};

int run_cli(const CLIOptions& options);

}  // namespace geode
```

## Test Cases

| Test | Command | Expected |
|------|---------|----------|
| Basic | `geode in.ply -o out.hga` | Success, HGA created |
| Classify only | `geode in.ply --classify-only -o m.json` | JSON manifest |
| Missing input | `geode missing.ply` | Exit 3, error message |
| Bad format | `geode image.png` | Exit 4, error message |
| Batch | `geode *.ply -o out/` | All files processed |
| Parallel | `geode *.ply -o out/ --parallel 4` | 4 concurrent |
| Override | `geode in.ply --planarity 0.8` | Uses 0.8 threshold |

## Example Workflows

### Game Asset Pipeline

```bash
# Process all scanned assets
for ply in scans/*.ply; do
    geode "$ply" -o "assets/$(basename "$ply" .ply).hga" --compress
done
```

### Threshold Tuning

```bash
# Test different thresholds
for p in 0.6 0.7 0.8; do
    geode scene.ply --classify-only --planarity $p \
        -o "results/planarity_${p}.json"
done
```

### CI Integration

```bash
# Validate all assets build without error
geode assets/*.ply -o /tmp/test/ --parallel $(nproc) --continue-on-error
if [ $? -ne 0 ]; then
    echo "Some assets failed to process"
    exit 1
fi
```

## Notes

- Default output is `<input_basename>.hga` in current directory
- Config file takes precedence over defaults, CLI flags over config
- Progress bars disabled when stdout is not a TTY (piped/redirected)
- Consider adding `--dry-run` for testing without writing files
