# Spec 4.3: Inspection Tools

**Module:** Visualization
**Phase:** 3 - Visualization
**Week:** 9

## Overview

Interactive tools for inspecting individual clusters, adjusting thresholds in real-time, and exporting results for analysis.

## Features

### 1. Cluster Selection

Click on a point to select its cluster and view detailed metrics.

#### Ray-Cast Selection

```cpp
void on_click(float screen_x, float screen_y) {
    // Get picked point index from Polyscope
    auto pick = polyscope::pick::evaluatePickQuery(screen_x, screen_y);

    if (pick.first == cloud_) {
        uint32_t point_idx = pick.second;
        uint32_t cluster_id = point_to_cluster_[point_idx];
        select_cluster(cluster_id);
    }
}
```

#### Selection Highlight

- Selected cluster: Bright outline or increased point size
- Other clusters: Dimmed (50% opacity)

```cpp
void highlight_cluster(uint32_t cluster_id) {
    std::vector<float> sizes(scene_.primitives.size(), 1.0f);
    std::vector<float> alphas(scene_.primitives.size(), 0.3f);

    for (uint32_t idx : clusters_[cluster_id].primitive_indices) {
        sizes[idx] = 2.0f;   // 2x point size
        alphas[idx] = 1.0f;  // Full opacity
    }

    cloud_->addScalarQuantity("highlight_size", sizes);
}
```

### 2. Cluster Info Panel

Display all metrics for selected cluster:

```
┌─────────────────────────────────────┐
│  Cluster 17 - MESH_OPTIMAL          │
│  Confidence: 0.85                   │
├─────────────────────────────────────┤
│  Primitives: 523                    │
│  Bounds: (1.2, 0.5, 0.1) -          │
│          (3.4, 2.1, 0.3)            │
├─────────────────────────────────────┤
│  PCA Metrics                        │
│    Planarity:    0.92  ████████░░   │
│    Linearity:    0.05  █░░░░░░░░░   │
│    Sphericity:   0.08  █░░░░░░░░░   │
├─────────────────────────────────────┤
│  Gaussian Metrics                   │
│    Erank Mean:   1.95  ████████░░   │
│    Erank Var:    0.12  ██░░░░░░░░   │
├─────────────────────────────────────┤
│  Alpha Metrics                      │
│    Mean:         0.94  █████████░   │
│    Variance:     0.02  █░░░░░░░░░   │
├─────────────────────────────────────┤
│  Normal Coherence: 0.88 ████████░░  │
└─────────────────────────────────────┘
```

Progress bars show value relative to threshold (green = passes, red = fails).

### 3. Threshold Adjustment

Real-time threshold tuning with live re-classification:

```cpp
void draw_threshold_sliders() {
    bool changed = false;

    changed |= ImGui::SliderFloat("Planarity", &thresholds_.planarity, 0.0f, 1.0f);
    changed |= ImGui::SliderFloat("Erank Low", &thresholds_.erank_low, 1.0f, 2.0f);
    changed |= ImGui::SliderFloat("Erank High", &thresholds_.erank_high, 2.0f, 3.0f);
    changed |= ImGui::SliderFloat("Alpha Mean", &thresholds_.alpha_mean, 0.0f, 1.0f);
    changed |= ImGui::SliderFloat("Alpha Var", &thresholds_.alpha_variance, 0.0f, 0.5f);
    changed |= ImGui::SliderFloat("Normal Coh.", &thresholds_.normal_coherence, 0.0f, 1.0f);

    if (changed) {
        reclassify_all();
        update_visualization();
    }

    if (ImGui::Button("Reset to Defaults")) {
        thresholds_ = Thresholds::defaults();
        reclassify_all();
    }

    if (ImGui::Button("Save Thresholds")) {
        save_thresholds("config/thresholds.json");
    }
}
```

### 4. Export Functions

#### PNG Screenshot

```cpp
void export_screenshot(const std::string& path) {
    polyscope::screenshot(path, /* transparent_bg */ false);
}
```

#### JSON Manifest

Export current classification state:

```cpp
void export_manifest(const std::string& path) {
    classifier_.write_manifest(path, results_, source_file_);
}
```

#### Colored PLY

Export point cloud with classification colors:

```cpp
void export_colored_ply(const std::string& path) {
    std::vector<Eigen::Vector3f> positions;
    std::vector<Eigen::Vector3ub> colors;

    for (size_t i = 0; i < scene_.primitives.size(); ++i) {
        positions.push_back(scene_.primitives[i].position);

        glm::vec3 c = current_colors_[i] * 255.0f;
        colors.push_back({(uint8_t)c.r, (uint8_t)c.g, (uint8_t)c.b});
    }

    write_ply(path, positions, colors);
}
```

## UI Layout

```
┌────────────────────────────────────────────────────────────────┐
│  [Viewport - 3D Scene]                                         │
│                                                                │
│                                                                │
│                                                                │
│                                                                │
├─────────────────────┬──────────────────────────────────────────┤
│  Visualization      │  Cluster Info         │  Thresholds      │
│  ───────────────    │  ─────────────        │  ──────────      │
│  Mode: [Classif▼]   │  Cluster 17           │  Plan: [==0.7=]  │
│  ■ Mesh (18)        │  MESH_OPTIMAL         │  Erank: [1.8-2.2]│
│  ■ Gauss (21)       │  Confidence: 0.85     │  Alpha: [==0.85=]│
│  ■ Uncert (3)       │  ...                  │  ...             │
│                     │  [Export Cluster]     │  [Reset] [Save]  │
└─────────────────────┴──────────────────────────────────────────┘
```

## Requirements

### Functional

- [ ] Click-to-select cluster via ray casting
- [ ] Highlight selected cluster (size + dim others)
- [ ] Cluster info panel with all metrics
- [ ] Visual pass/fail indicators for thresholds
- [ ] Threshold adjustment sliders
- [ ] Live re-classification on threshold change
- [ ] Export: PNG screenshot
- [ ] Export: JSON manifest
- [ ] Export: Colored PLY

### Performance

- [ ] Selection response < 50ms
- [ ] Re-classification < 500ms for interactive feedback
- [ ] Export operations non-blocking (or with progress)

## API

```cpp
namespace geode {

class InspectionController {
public:
    void set_scene(const Scene& scene,
                   const std::vector<Cluster>& clusters,
                   const std::vector<ClassificationResult>& results);

    // Selection
    void select_cluster(uint32_t cluster_id);
    void clear_selection();
    std::optional<uint32_t> selected_cluster() const;

    // Thresholds
    void set_thresholds(const Thresholds& t);
    const Thresholds& thresholds() const;

    // Export
    void export_screenshot(const std::filesystem::path& path);
    void export_manifest(const std::filesystem::path& path);
    void export_colored_ply(const std::filesystem::path& path);

    // UI
    void draw_ui();
    void handle_click(float x, float y);
};

}  // namespace geode
```

## Test Cases

| Test | Action | Expected |
|------|--------|----------|
| Click selection | Click on point | Cluster selected, panel updates |
| Click empty | Click on background | Selection cleared |
| Threshold change | Move planarity slider | Colors update, counts change |
| Export PNG | Click screenshot | File saved, correct colors |
| Export PLY | Click export PLY | Valid PLY with colors |
| Large scene | 500K points, adjust threshold | < 500ms update |

## Notes

- Selection persists across mode changes
- Threshold changes are not auto-saved (explicit save required)
- Export paths default to source file directory
- Consider undo/redo for threshold experimentation
